<section class='rating-widget'>
    <div class='rating-stars'>
        <ul id='stars' style="display: inline">
            <li class='star' title='Poor' data-value='1'>
                <i class='fa fa-star fa-fw'></i>
            </li>
            <li class='star' title='Fair' data-value='2'>
                <i class='fa fa-star fa-fw'></i>
            </li>
            <li class='star' title='Good' data-value='3'>
                <i class='fa fa-star fa-fw'></i>
            </li>
            <li class='star' title='Excellent' data-value='4'>
                <i class='fa fa-star fa-fw'></i>
            </li>
            <li class='star' title='WOW!!!' data-value='5'>
                <i class='fa fa-star fa-fw'></i>
            </li>
        </ul>
        <span class="rating-help-text">Click on the stars to edit rating</span>
        {% if rated == -1 %}
            <span class="score" hidden>{{ 0 }}</span>
        {% else %}
            <span class="score" hidden>{{ rated }}</span>
        {% endif %}
    </div>
    <br>
    {% if user.is_authenticated %}
        {% if liked %}
            <a data-href="{% url 'document_like' document.id %}" class="btn btn-primary" id="like-btn">Unlike</a>
        {% else %}
            <a data-href="{% url 'document_like' document.id %}" class="btn btn-primary" id="like-btn"> Like</a>
        {% endif %}
    {% endif %}
    {% if user == document.posted_user %}
        <a href="{% url 'document_update' document.id %}" class="btn btn-primary" style="margin-left:10px;"> <span
                class="glyphicon glyphicon-edit"></span>Edit</a>
        <a href="{% url 'document_delete' document.id %}" class="btn btn-primary" style="margin-left:10px;"> <span
                class="glyphicon glyphicon-remove"></span>Delete</a>
    {% endif %}
</section>
<script>
    function changeText() {
        $(`.rating-help-text`).text(`Click on the stars to edit rating`);
}
    $(document).ready(function () {
        let rated = parseInt($(`.score`).text());
        console.log(rated);
        let stars = $(`#stars li`).parent().children('li.star');
        for (let i = 0; i < rated; i++) {
                console.log(i);
                $(stars[i]).addClass('selected');
        }
        $('#stars li').on('mouseover', function () {
            var onStar = parseInt($(this).data('value'), 10);
            $(this).parent().children('li.star').each(function (e) {
                if (e < onStar) {
                    $(this).addClass('hover');
                }
                else {
                    $(this).removeClass('hover');
                }
            });

        }).on('mouseout', function () {
            $(this).parent().children('li.star').each(function (e) {
                $(this).removeClass('hover');
            });
        });

        $('#stars li').on('click', function () {
            let onStar = parseInt($(this).data('value'), 10); // The star currently selected
            let stars = $(this).parent().children('li.star');

            for (let i = 0; i < stars.length; i++) {
                $(stars[i]).removeClass('selected');
            }

            for (let i = 0; i < onStar; i++) {
                $(stars[i]).addClass('selected');
            }

            let score = parseInt($('#stars li.selected').last().data('value'), 10);
            let api_url = `/documents/rate/`;
            $(`.rating-help-text`).text(`Loading...`);
            $.ajax({
                url: api_url,
                method: "POST",
                data: {
                    'csrfmiddlewaretoken': `{{ csrf_token }}`,
                    'rating': score,
                    'document':{{ document.id }},
                    'user': {{ user.id}},
                },
                success: function (data) {
                    $(`.rating-text`).text(`${data.rate_avg} Rating/ ${data.number_of_votes} Votes`);
                    $(`.rating-help-text`).text(`Rated successfully!`);
                    $(`.score`).text(`${score}`);
                    setTimeout(changeText,500);
                },
                error: function () {
                     $(`#user-rating-text`).text(`Something went wrong!`);
                },

            });
        });
    });
</script>